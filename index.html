<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ホールデータまとめ</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- ローディング画面 -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">データを読み込み中...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
            <div class="loading-status" id="loadingStatus">初期化中...</div>
        </div>
    </div>
    
    <h1>📊 ホールデータまとめ</h1>

    <!-- タブ -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="daily">日別データ</button>
        <button class="tab-btn" data-tab="compare">日別比較</button>
        <button class="tab-btn" data-tab="trend">データトレンド</button>
        <button class="tab-btn" data-tab="calendar">カレンダー</button>
    </div>

    <!-- 日別データタブ -->
    <div id="daily" class="tab-content active">
        <div class="date-nav">
            <button id="prevDate">◀ 前日</button>
            <span class="current-date" id="currentDateLabel">-</span>
            <button id="nextDate">翌日 ▶</button>
        </div>

        <div class="controls">
            <select id="dateSelect"></select>
            <div id="dailyMachineFilterContainer"></div>
            <input type="text" id="search" placeholder="台番号で検索">
            <select id="sortBy">
                <option value="">並び替え</option>
                <option value="sa_desc">差枚 ↓</option>
                <option value="sa_asc">差枚 ↑</option>
                <option value="game_desc">G数 ↓</option>
                <option value="rate_desc">機械割 ↓</option>
                <option value="rate_asc">機械割 ↑</option>
                <option value="machine_asc">機種名 あ→わ</option>
                <option value="machine_desc">機種名 わ→あ</option>
                <option value="unit_asc">台番号 ↑</option>
                <option value="unit_desc">台番号 ↓</option>
            </select>
        </div>

        <!-- フィルターパネル（トグル式） -->
        <div class="filter-panel collapsible">
            <div class="filter-panel-header" id="filterToggle">
                <h4>🔍 フィルター・表示設定</h4>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="filter-panel-content" id="filterContent">
                <div class="filter-section">
                    <h5>🔢 数値フィルター</h5>
                    <p class="filter-hint">グループ内の条件はAND（すべて満たす）、グループ同士はOR（いずれか満たす）で判定します</p>
                    <div class="daily-filter-groups">
                        <div class="tag-groups-list" id="dailyFilterGroupsList"></div>
                        <div class="tag-groups-actions">
                            <button class="btn-small" id="dailyAddFilterGroup">＋ 条件グループを追加</button>
                        </div>
                    </div>
                    <div class="filter-buttons">
                        <button class="btn-apply" id="applyFilter">フィルター適用</button>
                        <button class="btn-reset" id="resetFilter">リセット</button>
                    </div>
                </div>

                <!-- 高設定タグ条件セクション -->
                <div class="filter-section">
                    <h5>🏷️ 高設定タグ条件</h5>
                    <p class="filter-hint">グループ内の条件はAND（すべて満たす）、グループ同士はOR（いずれか満たす）で判定します</p>
                    <div class="high-setting-tag-config">
                        <div class="tag-groups-list" id="dailyTagGroupsList"></div>
                        <div class="tag-groups-actions">
                            <button class="btn-small" id="dailyAddTagGroup">＋ 条件グループを追加</button>
                        </div>
                        <div class="tag-preset-row">
                            <span class="tag-preset-label">プリセット:</span>
                            <div class="tag-preset-buttons">
                                <button class="preset-btn" data-preset="suspect" data-context="daily">高設定疑惑</button>
                            </div>
                        </div>
                        <div class="tag-display-row">
                            <label class="column-checkbox-item">
                                <input type="checkbox" id="dailyShowHighSettingOnly">
                                <span>高設定タグ付きのみ表示</span>
                            </label>
                            <span class="tag-count-display" id="dailyTagCountDisplay"></span>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h5>📋 表示列</h5>
                    <div class="column-selector-controls">
                        <button class="btn-small" id="selectAllColumns">全選択</button>
                        <button class="btn-small" id="deselectAllColumns">全解除</button>
                    </div>
                    <div class="column-checkboxes" id="columnCheckboxes"></div>
                </div>
            </div>
        </div>

        <div class="summary" id="summary"></div>

        <div class="table-actions">
            <button class="btn-copy" id="copyTableBtn" title="テーブルをクリップボードにコピー">📋 コピー</button>
            <button class="btn-download" id="downloadCsvBtn" title="CSVファイルをダウンロード">💾 CSV</button>
        </div>

        <div class="table-wrapper">
            <table id="data-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>


    <!-- 日別比較タブ -->
    <div id="compare" class="tab-content">
        <div class="compare-header">
            <h2>📅 日別データ比較</h2>
            <p class="compare-description">2つの日付のデータを並べて比較します</p>
        </div>

        <div class="compare-date-selectors">
            <div class="compare-date-group">
                <label>前回</label>
                <select id="compareDateA"></select>
                <span class="compare-date-info" id="compareDateAInfo"></span>
            </div>
            <div class="compare-swap-btn-wrapper">
                <button id="compareSwapDates" class="btn-swap" title="日付を入れ替え">⇄</button>
            </div>
            <div class="compare-date-group">
                <label>今回</label>
                <select id="compareDateB"></select>
                <span class="compare-date-info" id="compareDateBInfo"></span>
            </div>
        </div>

        <div class="compare-controls">
            <div class="control-group">
                <label>比較項目:</label>
                <select id="compareDataColumn">
                    <option value="差枚">差枚</option>
                    <option value="G数">G数</option>
                    <option value="BB">BB回数</option>
                    <option value="RB">RB回数</option>
                    <option value="ART">ART回数</option>
                    <option value="機械割">機械割</option>
                </select>
            </div>
            <div class="control-group">
                <label>機種:</label>
                <div id="compareMachineFilterContainer"></div>
            </div>
            <div class="control-group">
                <label>並び替え:</label>
                <select id="compareSortBy">
                    <option value="diff_desc">差分 多い順</option>
                    <option value="diff_asc">差分 少ない順</option>
                    <option value="a_desc">前回 多い順</option>
                    <option value="a_asc">前回 少ない順</option>
                    <option value="b_desc">今回 多い順</option>
                    <option value="b_asc">今回 少ない順</option>
                    <option value="unit_asc">台番号 ↑</option>
                    <option value="unit_desc">台番号 ↓</option>
                    <option value="machine_asc">機種名 あ→わ</option>
                </select>
            </div>
            <button id="loadCompare" class="btn-apply">比較実行</button>
        </div>

        <!-- フィルターパネル -->
        <div class="filter-panel collapsible">
            <div class="filter-panel-header" id="compareFilterToggle">
                <h4>🔍 フィルター設定</h4>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="filter-panel-content" id="compareFilterContent">
                <div class="filter-section">
                    <h5>数値フィルター</h5>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>差分</label>
                            <select id="compareDiffFilterType">
                                <option value="">--</option>
                                <option value="gte">以上</option>
                                <option value="lte">以下</option>
                            </select>
                            <input type="number" id="compareDiffFilterValue" placeholder="値">
                        </div>
                        <div class="filter-item">
                            <label>表示</label>
                            <select id="compareShowFilter">
                                <option value="">全て</option>
                                <option value="improved">改善のみ（今回 > 前回）</option>
                                <option value="declined">悪化のみ（今回 < 前回）</option>
                                <option value="both">両日データあり</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>台番号末尾</label>
                            <select id="compareUnitSuffixFilter">
                                <option value="">全て</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-buttons">
                        <button class="btn-reset" id="resetCompareFilter">リセット</button>
                    </div>
                </div>

                <div class="filter-section">
                    <h5>🏷️ 高設定タグ条件</h5>
                    <p class="filter-hint">グループ内の条件はAND（すべて満たす）、グループ同士はOR（いずれか満たす）で判定します</p>
                    <div class="high-setting-tag-config">
                        <div class="tag-groups-list" id="tagGroupsList"></div>
                        <div class="tag-groups-actions">
                            <button class="btn-small" id="addTagGroup">＋ 条件グループを追加</button>
                        </div>
                        <div class="tag-preset-row">
                            <span class="tag-preset-label">プリセット:</span>
                            <div class="tag-preset-buttons">
                                <button class="preset-btn" data-preset="suspect">高設定疑惑</button>
                            </div>
                        </div>
                        <div class="tag-display-row">
                            <label class="column-checkbox-item">
                                <input type="checkbox" id="showHighSettingOnly">
                                <span>高設定タグ付きのみ表示</span>
                            </label>
                            <label class="column-checkbox-item">
                                <input type="checkbox" id="showTagBothDays">
                                <span>両日タグ付きのみ</span>
                            </label>
                            <span class="tag-count-display" id="tagCountDisplay"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="compare-summary-cards" id="compareSummary"></div>

        <div class="compare-analysis-container" id="compareAnalysisContainer">
            <div class="analysis-header">
                <h4>🏷️ 高設定タグ分析</h4>
                <div class="analysis-controls">
                    <div class="control-group">
                        <label>表示:</label>
                        <select id="analysisViewMode">
                            <option value="overall">全体</option>
                            <option value="machine">機種別</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="analysis-summary" id="analysisSummary"></div>
            <div class="analysis-tables" id="analysisTables"></div>
        </div>

        <div class="table-actions">
            <button class="btn-copy" id="copyCompareTableBtn" title="テーブルをクリップボードにコピー">📋 コピー</button>
            <button class="btn-download" id="downloadCompareCsvBtn" title="CSVファイルをダウンロード">💾 CSV</button>
        </div>

        <div class="table-wrapper">
            <table id="compare-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- データトレンドタブ -->
    <div id="trend" class="tab-content">
        <div class="controls">
            <div class="control-group">
                <label>表示期間:</label>
                <button id="openTrendCalendar" class="calendar-btn">📅 日付を選択</button>
                <span id="trendPeriodLabel" class="period-label-inline">7日間</span>
            </div>
            <div class="control-group">
                <label>表示モード:</label>
                <select id="trendViewMode">
                    <option value="unit">台別</option>
                    <option value="machine">機種別</option>
                </select>
            </div>
            <div class="control-group">
                <label>データ項目:</label>
                <select id="trendDataColumn">
                    <option value="差枚">差枚</option>
                    <option value="G数">G数</option>
                    <option value="BB">BB回数</option>
                    <option value="RB">RB回数</option>
                    <option value="ART">ART回数</option>
                    <option value="合成確率">合成確率</option>
                    <option value="BB確率">BB確率</option>
                    <option value="RB確率">RB確率</option>
                    <option value="機械割">機械割</option>
                </select>
            </div>
            <div class="control-group" id="machineAggTypeGroup" style="display: none;">
                <label>集計方法:</label>
                <select id="trendMachineAggType">
                    <option value="total">合計</option>
                    <option value="avg">平均</option>
                </select>
            </div>
            <div class="control-group">
                <label>機種:</label>
                <div id="trendMachineFilterContainer"></div>
            </div>
            <div class="control-group">
                <label>並び替え:</label>
                <select id="trendSortBy">
                    <option value="total_desc">合計 多い順</option>
                    <option value="total_asc">合計 少ない順</option>
                    <option value="avg_desc">平均 多い順</option>
                    <option value="latest_desc">最新日 多い順</option>
                    <option value="prevtotal_desc">最新日以前 多い順</option>
                    <option value="prevtotal_asc">最新日以前 少ない順</option>
                    <option value="machine_asc">機種名 あ→わ</option>
                    <option value="machine_desc">機種名 わ→あ</option>
                    <option value="unit_asc">台番号 ↑</option>
                    <option value="unit_desc">台番号 ↓</option>
                </select>
            </div>
            <button id="loadTrend" class="btn-apply">表示更新</button>
        </div>

        <div class="filter-panel collapsible">
            <div class="filter-panel-header" id="trendFilterToggle">
                <h4>🔍 フィルター・表示設定</h4>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="filter-panel-content" id="trendFilterContent">
                <div class="filter-section">
                    <h5>数値フィルター</h5>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>合計値</label>
                            <select id="trendTotalFilterType">
                                <option value="">--</option>
                                <option value="gte">以上</option>
                                <option value="lte">以下</option>
                            </select>
                            <input type="number" id="trendTotalFilterValue" placeholder="値">
                        </div>
                        <div class="filter-item">
                            <label>最新日以前</label>
                            <select id="trendPrevTotalFilterType">
                                <option value="">--</option>
                                <option value="gte">以上</option>
                                <option value="lte">以下</option>
                            </select>
                            <input type="number" id="trendPrevTotalFilterValue" placeholder="値">
                        </div>
                    </div>
                </div>
                <div class="filter-section">
                    <h5>📋 表示列</h5>
                    <div class="column-checkboxes">
                        <label class="column-checkbox-item">
                            <input type="checkbox" id="trendShowTotal" checked>
                            <span>合計</span>
                        </label>
                        <label class="column-checkbox-item">
                            <input type="checkbox" id="trendShowAvg" checked>
                            <span>平均</span>
                        </label>
                        <label class="column-checkbox-item">
                            <input type="checkbox" id="trendShowPrevTotal">
                            <span>最新日以前</span>
                        </label>
                    </div>
                </div>
                <div class="filter-section">
                    <h5>📈 グラフ表示</h5>
                    <div class="column-checkboxes">
                        <label class="column-checkbox-item">
                            <input type="checkbox" id="trendShowChart" checked>
                            <span>グラフを表示</span>
                        </label>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn-reset" id="resetTrendFilter">リセット</button>
                </div>
            </div>
        </div>

        <div id="trendCalendarModal" class="calendar-modal">
            <div class="calendar-modal-content calendar-modal-large">
                <div class="calendar-modal-header">
                    <h3>表示する日付を選択</h3>
                    <button id="closeTrendCalendar" class="close-btn">×</button>
                </div>
                <div id="trendFilterContainer" class="trend-modal-filters"></div>
                <div class="calendar-modal-body">
                    <div id="trendDateList" class="date-checkbox-list"></div>
                </div>
                <div class="calendar-modal-footer">
                    <button id="selectAllDates" class="modal-btn">全選択</button>
                    <button id="deselectAllDates" class="modal-btn">全解除</button>
                    <button id="applyTrendDates" class="modal-btn primary">適用</button>
                </div>
            </div>
        </div>

        <div id="trendSummary" class="summary"></div>

        <div class="trend-chart-container">
            <div class="chart-header">
                <h4 id="trendChartTitle">📈 差枚推移グラフ</h4>
                <div class="chart-controls">
                    <label><input type="checkbox" id="chartShowTop" checked> 上位</label>
                    <label><input type="checkbox" id="chartShowBottom"> 下位</label>
                    <select id="chartDisplayCount">
                        <option value="5">5件表示</option>
                        <option value="10">10件表示</option>
                        <option value="20">20件表示</option>
                    </select>
                    <select id="chartDisplayType">
                        <option value="cumulative">累積</option>
                        <option value="daily">日別</option>
                    </select>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="table-actions">
            <button class="btn-copy" id="copyTrendTableBtn" title="テーブルをクリップボードにコピー">📋 コピー</button>
            <button class="btn-download" id="downloadTrendCsvBtn" title="CSVファイルをダウンロード">💾 CSV</button>
        </div>

        <div class="table-wrapper has-scrollbar">
            <div class="fixed-columns">
                <table id="trend-fixed-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="scroll-columns">
                <table id="trend-scroll-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- カレンダータブ -->
    <div id="calendar" class="tab-content">
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonth">◀ 前月</button>
                <h2 id="calendarMonth"></h2>
                <button id="nextMonth">次月 ▶</button>
            </div>
            <div id="calendarFilter" class="calendar-filter-container"></div>
            <div class="calendar-scroll-wrapper">
                <div class="calendar-weekdays">
                    <div class="weekday sunday">日</div>
                    <div class="weekday">月</div>
                    <div class="weekday">火</div>
                    <div class="weekday">水</div>
                    <div class="weekday">木</div>
                    <div class="weekday">金</div>
                    <div class="weekday saturday">土</div>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>
            <div class="calendar-legend">
                <div class="legend-item"><span class="legend-bar avg-sa"></span><span>平均差枚</span></div>
                <div class="legend-item"><span class="legend-bar avg-game"></span><span>平均G数</span></div>
                <div class="legend-item"><span class="legend-bar win-rate"></span><span>勝率</span></div>
                <div class="legend-item"><span class="legend-bar total-sa"></span><span>総差枚</span></div>
            </div>
        </div>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/preset.js"></script>
    <script src="js/hstag.js"></script>
    <script src="js/daily.js"></script>
    <script src="js/trend.js"></script>
    <script src="js/compare.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
